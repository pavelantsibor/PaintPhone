<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üé® –•–æ–ª—Å—Ç —Ö—É–¥–æ–∂–Ω–∏–∫–∞</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #111; font-family: Arial, sans-serif; color: white; overflow: hidden; height: 100vh; }
    #ui {
      position: fixed; top: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.8);
      padding: 10px 20px;
      display: flex; align-items: center; gap: 16px;
      z-index: 10; backdrop-filter: blur(8px);
    }
    #room-code { font-size: 22px; font-weight: bold; letter-spacing: 5px; color: #ffd700; }
    #status { font-size: 13px; padding: 4px 12px; border-radius: 20px; background: rgba(255,200,0,0.2); color: #ffd700; }
    #status.connected { background: rgba(0,200,100,0.2); color: #0f0; }
    #clear-btn {
      margin-left: auto; background: rgba(255,50,50,0.3);
      border: 1px solid rgba(255,50,50,0.5); color: white;
      padding: 5px 14px; border-radius: 20px; cursor: pointer;
    }
    #canvas-wrap { position: absolute; top: 50px; left: 0; right: 0; bottom: 0; }
    canvas#c { display: block; width: 100%; height: 100%; }
    #brush {
      position: fixed; border-radius: 50%; pointer-events: none;
      transform: translate(-50%, -50%); border: 2px solid #333;
      transition: left 0.04s, top 0.04s;
    }
    #overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100;
    }
    #overlay h2 { font-size: 26px; margin-bottom: 8px; }
    #overlay p { color: #aaa; margin-bottom: 20px; }
    #code-big { font-size: 52px; font-weight: bold; letter-spacing: 12px; color: #ffd700; margin: 10px 0; }
    #phone-url { font-size: 13px; color: #aaa; max-width: 500px; text-align: center; margin-top: 10px; word-break: break-all; }
    #qr { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    #wait { animation: pulse 1.5s infinite; color: #888; font-size: 14px; margin-top: 16px; }
  </style>
</head>
<body>

<div id="ui">
  <span>üé® –•–æ–ª—Å—Ç —Ö—É–¥–æ–∂–Ω–∏–∫–∞</span>
  <div id="room-code">‚Äî</div>
  <div id="status">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
  <button id="clear-btn">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<div id="canvas-wrap">
  <canvas id="c"></canvas>
</div>

<div id="brush"></div>

<div id="overlay">
  <h2>üì± –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω-–∫–∏—Å—Ç—å</h2>
  <p>–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR</p>
  <div id="qr"></div>
  <div id="code-big">‚Äî</div>
  <div id="phone-url">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏...</div>
  <div id="wait">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const brush = document.getElementById('brush');
const overlay = document.getElementById('overlay');

function resize() {
  const w = canvas.parentElement.offsetWidth;
  const h = canvas.parentElement.offsetHeight;
  const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
  canvas.width = w; canvas.height = h;
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, w, h);
}
resize();
window.addEventListener('resize', resize);

let isDrawing = false, lastX = null, lastY = null;
let color = '#1a1a1a', size = 10;
let nx = 0.5, ny = 0.5;

function draw() {
  const x = nx * canvas.width;
  const y = ny * canvas.height;
  const screenY = 50 + ny * (window.innerHeight - 50);
  brush.style.left = (nx * 100) + '%';
  brush.style.top = screenY + 'px';
  brush.style.width = size * 2 + 'px';
  brush.style.height = size * 2 + 'px';
  brush.style.background = isDrawing ? color : 'transparent';
  brush.style.borderColor = color;

  if (!isDrawing || lastX === null) { lastX = x; lastY = y; return; }
  ctx.strokeStyle = color;
  ctx.lineWidth = size;
  ctx.lineCap = 'round'; ctx.lineJoin = 'round';
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(x, y);
  ctx.stroke();
  lastX = x; lastY = y;
}

// PeerJS
const peer = new Peer({ debug: 0 });

peer.on('open', id => {
  const code = id.slice(-6).toUpperCase();
  document.getElementById('room-code').textContent = code;
  document.getElementById('code-big').textContent = code;

  const base = location.href.replace('index.html', '').replace(/\/$/, '');
  const phoneUrl = base + '/phone.html?room=' + id;
  document.getElementById('phone-url').textContent = phoneUrl;

  // Simple QR via API
  const qrDiv = document.getElementById('qr');
  const img = document.createElement('img');
  img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(phoneUrl);
  img.width = 180; img.height = 180;
  qrDiv.appendChild(img);
});

peer.on('connection', conn => {
  conn.on('open', () => {
    overlay.style.display = 'none';
    document.getElementById('status').className = 'connected';
    document.getElementById('status').textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á—ë–Ω';
  });
  conn.on('data', d => {
    if (d.type === 'move') {
      nx = Math.max(0, Math.min(1, nx + d.dx * 0.012));
      ny = Math.max(0, Math.min(1, ny + d.dy * 0.012));
      draw();
    } else if (d.type === 'draw') {
      isDrawing = d.v;
      if (!isDrawing) { lastX = null; lastY = null; }
      draw();
    } else if (d.type === 'color') { color = d.v; brush.style.borderColor = color; }
    else if (d.type === 'size') { size = d.v; }
    else if (d.type === 'clear') {
      ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
      lastX = null; lastY = null;
    }
  });
  conn.on('close', () => {
    document.getElementById('status').className = '';
    document.getElementById('status').textContent = '‚è≥ –û—Ç–∫–ª—é—á–∏–ª—Å—è';
    overlay.style.display = 'flex';
    lastX = null; lastY = null; isDrawing = false;
  });
});

document.getElementById('clear-btn').addEventListener('click', () => {
  ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
});
</script>
</body>
</html>
