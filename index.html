<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üé® –•–æ–ª—Å—Ç —Ö—É–¥–æ–∂–Ω–∏–∫–∞</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #111; font-family: Arial, sans-serif; color: white; overflow: hidden; height: 100vh; }
    #ui {
      position: fixed; top: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.85); padding: 10px 20px;
      display: flex; align-items: center; gap: 16px; z-index: 10;
    }
    #room-code { font-size: 22px; font-weight: bold; letter-spacing: 5px; color: #ffd700; }
    #status { font-size: 13px; padding: 4px 12px; border-radius: 20px; background: rgba(255,200,0,0.2); color: #ffd700; }
    #status.connected { background: rgba(0,200,100,0.2); color: #0f0; }
    #clear-btn {
      margin-left: auto; background: rgba(255,50,50,0.3);
      border: 1px solid rgba(255,50,50,0.5); color: white;
      padding: 5px 14px; border-radius: 20px; cursor: pointer; font-size: 14px;
    }
    #canvas-wrap { position: absolute; top: 50px; left: 0; right: 0; bottom: 0; }
    canvas#c { display: block; width: 100%; height: 100%; }
    #brush {
      position: fixed; border-radius: 50%; pointer-events: none;
      transform: translate(-50%, -50%); border: 3px solid #333;
      z-index: 5;
    }
    #overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.92);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100; gap: 10px;
    }
    #overlay h2 { font-size: 28px; }
    #overlay p { color: #aaa; font-size: 15px; }
    #code-big { font-size: 56px; font-weight: bold; letter-spacing: 14px; color: #ffd700; margin: 6px 0; }
    #qr-img { border-radius: 12px; }
    #phone-url {
      font-size: 13px; color: #6af; max-width: 600px; text-align: center;
      word-break: break-all; background: rgba(255,255,255,0.05);
      padding: 8px 14px; border-radius: 8px;
    }
    #debug { font-size: 11px; color: #555; margin-top: 4px; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
    #wait { animation: pulse 1.5s infinite; color: #666; font-size: 13px; }
  </style>
</head>
<body>

<div id="ui">
  <span>üé® –•–æ–ª—Å—Ç</span>
  <div id="room-code">‚Äî</div>
  <div id="status">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</div>
  <button id="clear-btn">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<div id="canvas-wrap"><canvas id="c"></canvas></div>
<div id="brush"></div>

<div id="overlay">
  <h2>üì± –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω-–∫–∏—Å—Ç—å</h2>
  <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</p>
  <img id="qr-img" width="200" height="200" src="" alt="QR">
  <div id="code-big">‚Äî</div>
  <div id="phone-url">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
  <div id="wait">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞...</div>
  <div id="debug"></div>
</div>

<script>
// Canvas setup
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const brush = document.getElementById('brush');

function resize() {
  canvas.width = canvas.parentElement.offsetWidth;
  canvas.height = canvas.parentElement.offsetHeight;
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}
resize();
window.addEventListener('resize', resize);

let isDrawing = false, lastX = null, lastY = null;
let color = '#1a1a1a', size = 10;
let nx = 0.5, ny = 0.5;

function draw() {
  const x = nx * canvas.width;
  const y = ny * canvas.height;
  brush.style.left = (nx * 100) + 'vw';
  brush.style.top = (50 + ny * (window.innerHeight - 50)) + 'px';
  brush.style.width = size * 2 + 'px';
  brush.style.height = size * 2 + 'px';
  brush.style.background = isDrawing ? color : 'transparent';
  brush.style.borderColor = color;
  if (!isDrawing || lastX === null) { lastX = x; lastY = y; return; }
  ctx.strokeStyle = color; ctx.lineWidth = size;
  ctx.lineCap = 'round'; ctx.lineJoin = 'round';
  ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke();
  lastX = x; lastY = y;
}

function handleData(d) {
  if (d.type === 'move') {
    nx = Math.max(0, Math.min(1, nx + d.dx * 0.012));
    ny = Math.max(0, Math.min(1, ny + d.dy * 0.012));
    draw();
  } else if (d.type === 'draw') {
    isDrawing = d.v; if (!isDrawing) { lastX = null; lastY = null; } draw();
  } else if (d.type === 'color') { color = d.v; }
  else if (d.type === 'size') { size = d.v; }
  else if (d.type === 'clear') {
    ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    lastX = null; lastY = null;
  }
}

document.getElementById('clear-btn').addEventListener('click', () => {
  ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
});

// === PEERJS —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–µ—Ä–≤–µ—Ä–∞–º–∏-–∑–∞–ø–∞—Å–Ω—ã–º–∏ ===
const debug = document.getElementById('debug');
let peer, peerReady = false;

function setDebug(msg) { debug.textContent = msg; }
function setUrl(peerId) {
  const base = location.href.replace(/\/[^/]*$/, '');
  const phoneUrl = base + '/phone.html?room=' + peerId;
  document.getElementById('phone-url').textContent = phoneUrl;
  document.getElementById('qr-img').src =
    'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(phoneUrl);
  const code = peerId.slice(-6).toUpperCase();
  document.getElementById('room-code').textContent = code;
  document.getElementById('code-big').textContent = code;
}

function tryPeer(config, attempt) {
  setDebug('–ü–æ–ø—ã—Ç–∫–∞ ' + attempt + '...');
  if (peer) { try { peer.destroy(); } catch(e) {} }

  peer = config ? new Peer(config) : new Peer();

  const timeout = setTimeout(() => {
    setDebug('–¢–∞–π–º–∞—É—Ç –ø–æ–ø—ã—Ç–∫–∏ ' + attempt);
    if (!peerReady) tryNext(attempt);
  }, 6000);

  peer.on('open', id => {
    clearTimeout(timeout);
    peerReady = true;
    setDebug('‚úÖ –°–µ—Ä–≤–µ—Ä: ' + (attempt === 1 ? 'default' : attempt === 2 ? 'peerjs.com' : 'custom'));
    setUrl(id);
  });

  peer.on('error', e => {
    clearTimeout(timeout);
    setDebug('–û—à–∏–±–∫–∞ –ø–æ–ø—ã—Ç–∫–∏ ' + attempt + ': ' + e.type);
    if (!peerReady) tryNext(attempt);
  });

  peer.on('connection', conn => {
    conn.on('open', () => {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('status').className = 'connected';
      document.getElementById('status').textContent = '‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á—ë–Ω';
    });
    conn.on('data', handleData);
    conn.on('close', () => {
      document.getElementById('status').className = '';
      document.getElementById('status').textContent = '‚è≥ –û—Ç–∫–ª—é—á–∏–ª—Å—è';
      document.getElementById('overlay').style.display = 'flex';
      isDrawing = false; lastX = null; lastY = null;
    });
  });
}

function tryNext(attempt) {
  if (attempt === 1) {
    tryPeer({ host: '0.peerjs.com', port: 443, path: '/', secure: true,
      config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
    }, 2);
  } else if (attempt === 2) {
    tryPeer({ host: 'peerjs.herokuapp.com', port: 443, path: '/', secure: true }, 3);
  } else {
    setDebug('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∏ –∫ –æ–¥–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ –ø—Ä–æ–µ–∫—Ç–æ—Ä–µ.');
    document.getElementById('phone-url').textContent = '‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –∏–ª–∏ WebRTC –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
    document.getElementById('wait').textContent = '‚ùå –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É';
  }
}

// –ù–∞—á–∏–Ω–∞–µ–º —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ PeerJS
tryPeer(null, 1);
</script>
</body>
</html>
