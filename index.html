<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>üé® –ö–∏—Å—Ç—å-—Ö–æ–ª—Å—Ç</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#09091a; color:white; font-family:Arial,sans-serif;
      height:100vh; overflow:hidden; display:flex; align-items:center; justify-content:center;
    }

    /* ‚îÄ‚îÄ –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω ‚îÄ‚îÄ */
    #s-home {
      display:flex; flex-direction:column; align-items:center; gap:20px; padding:30px;
    }
    #s-home h1 { font-size:36px; }
    #s-home p  { color:#666; font-size:15px; }
    .big-btn {
      width:260px; padding:18px; border-radius:18px; border:none;
      font-size:18px; cursor:pointer; transition:transform .1s, opacity .1s;
    }
    .big-btn:active { transform:scale(.97); opacity:.85; }
    #btn-host  { background:#4a90e2; color:white; }
    #btn-phone { background:rgba(255,255,255,0.08); color:white; border:1px solid rgba(255,255,255,0.15); }

    /* ‚îÄ‚îÄ –≠–∫—Ä–∞–Ω—ã ‚îÄ‚îÄ */
    .screen { display:none; flex-direction:column; align-items:center; gap:14px; padding:24px; width:100%; max-width:580px; }
    .screen.active { display:flex; }

    h2 { font-size:22px; }
    .sub { color:#666; font-size:13px; text-align:center; }

    /* –ö–æ–¥ */
    .code-box {
      width:100%; background:#000; color:#0f0;
      font-family:'Courier New',monospace; font-size:11px;
      padding:12px; border-radius:10px; word-break:break-all;
      max-height:75px; overflow:hidden; line-height:1.5;
      border:1px solid rgba(0,255,0,0.2);
    }
    textarea.code-box { resize:none; height:75px; width:100%; outline:none; }

    .btn {
      width:100%; padding:13px; border-radius:13px; border:none;
      font-size:16px; cursor:pointer; color:white;
    }
    .btn-blue  { background:#4a90e2; }
    .btn-green { background:#00c853; }
    .btn-red   { background:rgba(255,50,50,0.25); border:1px solid rgba(255,50,50,0.35); }
    .btn:active { opacity:.8; }
    .btn:disabled { background:#333; color:#555; cursor:default; }

    .lbl { font-size:12px; color:#888; text-transform:uppercase; letter-spacing:1px; align-self:flex-start; }
    #msg { font-size:13px; color:#888; min-height:16px; text-align:center; }

    /* ‚îÄ‚îÄ –•–æ–ª—Å—Ç (—Ö–æ—Å—Ç) ‚îÄ‚îÄ */
    #s-canvas {
      position:fixed; inset:0; display:none; flex-direction:column;
    }
    #s-canvas.active { display:flex; }
    #topbar {
      height:48px; background:rgba(0,0,0,0.9); display:flex;
      align-items:center; gap:12px; padding:0 16px; flex-shrink:0;
      border-bottom:1px solid rgba(255,255,255,0.07);
      z-index:10;
    }
    #dot { width:9px; height:9px; border-radius:50%; background:#ffd700; }
    #dot.on { background:#00ff88; box-shadow:0 0 6px #00ff88; }
    #bar-status { font-size:13px; color:#aaa; }
    #btn-clear { margin-left:auto; background:rgba(255,50,50,.25); border:1px solid rgba(255,50,50,.4); color:white; padding:5px 14px; border-radius:16px; cursor:pointer; font-size:13px; }
    #btn-reconnect { background:rgba(74,144,226,.25); border:1px solid rgba(74,144,226,.4); color:white; padding:5px 14px; border-radius:16px; cursor:pointer; font-size:13px; }
    canvas { flex:1; display:block; }
    #brush { position:fixed; border-radius:50%; pointer-events:none; transform:translate(-50%,-50%); border:3px solid #333; z-index:5; display:none; }

    /* ‚îÄ‚îÄ –≠–∫—Ä–∞–Ω —Ä–∏—Å–æ–≤–∞–Ω–∏—è (—Ç–µ–ª–µ—Ñ–æ–Ω) ‚îÄ‚îÄ */
    #brush-btn {
      width:175px; height:175px; border-radius:50%; margin:4px 0;
      background:radial-gradient(circle at 40% 35%, #2a5298, #0e1f4a);
      border:5px solid #4a90e2; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      box-shadow:0 0 35px rgba(74,144,226,.3);
      -webkit-tap-highlight-color:transparent;
      transition:transform .1s, background .15s;
    }
    #brush-btn.on {
      background:radial-gradient(circle at 40% 35%, #8b0000, #3a0000);
      border-color:#ff4444; box-shadow:0 0 45px rgba(255,68,68,.5);
      transform:scale(.93);
    }
    #brush-btn .ico { font-size:46px; pointer-events:none; }
    #brush-btn .lbl2 { font-size:12px; color:rgba(255,255,255,.7); pointer-events:none; }
    #hint { font-size:11px; color:#444; text-align:center; }
    .ctrl { width:100%; }
    .ctrl label { font-size:12px; color:#888; display:block; margin-bottom:4px; }
    input[type=range] { width:100%; accent-color:#4a90e2; }
    .palette { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .cb { width:34px; height:34px; border-radius:50%; cursor:pointer; border:3px solid transparent; transition:border-color .15s, transform .1s; -webkit-tap-highlight-color:transparent; }
    .cb.sel { border-color:white; transform:scale(1.15); }
    input[type=color] { width:44px; height:34px; border:none; border-radius:8px; cursor:pointer; margin-top:6px; }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω ‚îÄ‚îÄ -->
<div id="s-home">
  <h1>üé® –•–æ–ª—Å—Ç</h1>
  <p>–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?</p>
  <button class="big-btn" id="btn-host">üñ• –û—Ç–∫—Ä—ã—Ç—å —Ö–æ–ª—Å—Ç<br><small style="font-size:13px;opacity:.7">–Ω–∞ –ø—Ä–æ–µ–∫—Ç–æ—Ä–µ / –±–æ–ª—å—à–æ–º —ç–∫—Ä–∞–Ω–µ</small></button>
  <button class="big-btn" id="btn-phone">üì± –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∏—Å—Ç—å<br><small style="font-size:13px;opacity:.7">—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞</small></button>
</div>

<!-- ‚îÄ‚îÄ –•–æ—Å—Ç: –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ ‚îÄ‚îÄ -->
<div class="screen" id="s-host-code">
  <h2>üñ• –•–æ–ª—Å—Ç –≥–æ—Ç–æ–≤</h2>
  <p class="sub">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω</p>
  <div class="lbl">–í–∞—à –∫–æ–¥ (—à–∞–≥ 1):</div>
  <div class="code-box" id="offer-box">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</div>
  <button class="btn btn-blue" id="btn-copy-offer">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
  <div class="lbl" style="margin-top:4px">–í—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—à–∞–≥ 2):</div>
  <textarea class="code-box" id="answer-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –æ—Ç–≤–µ—Ç —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞..."></textarea>
  <button class="btn btn-green" id="btn-apply-answer">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å!</button>
  <div id="msg"></div>
</div>

<!-- ‚îÄ‚îÄ –¢–µ–ª–µ—Ñ–æ–Ω: –≤–≤–µ—Å—Ç–∏ –∫–æ–¥ ‚îÄ‚îÄ -->
<div class="screen" id="s-phone-code">
  <h2>üì± –¢–µ–ª–µ—Ñ–æ–Ω-–∫–∏—Å—Ç—å</h2>
  <p class="sub">–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —Å –ø—Ä–æ–µ–∫—Ç–æ—Ä–∞</p>
  <div class="lbl">–ö–æ–¥ —Å –ø—Ä–æ–µ–∫—Ç–æ—Ä–∞ (—à–∞–≥ 1):</div>
  <textarea class="code-box" id="offer-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –∫–æ–¥ —Å –ø—Ä–æ–µ–∫—Ç–æ—Ä–∞..."></textarea>
  <button class="btn btn-blue" id="btn-process-offer">‚ö° –û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
  <div id="msg2"></div>
  <div id="answer-section" style="display:none;width:100%;display:none;flex-direction:column;gap:10px">
    <div class="lbl">–í–∞—à –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥ (—à–∞–≥ 2) ‚Äî —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–æ—Ä–µ:</div>
    <div class="code-box" id="answer-box">...</div>
    <button class="btn btn-green" id="btn-copy-answer">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ –•–æ–ª—Å—Ç (—Ö–æ—Å—Ç) ‚îÄ‚îÄ -->
<div id="s-canvas">
  <div id="topbar">
    <div id="dot"></div>
    <div id="bar-status">–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞...</div>
    <button id="btn-reconnect">üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    <button id="btn-clear">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>
  <canvas id="c"></canvas>
  <div id="brush"></div>
</div>

<!-- ‚îÄ‚îÄ –†–∏—Å–æ–≤–∞–Ω–∏–µ (—Ç–µ–ª–µ—Ñ–æ–Ω) ‚îÄ‚îÄ -->
<div class="screen" id="s-draw" style="overflow-y:auto;height:100vh;justify-content:flex-start;padding-top:20px">
  <h2>üñå –ö–∏—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞!</h2>
  <div id="brush-btn">
    <div class="ico">‚úèÔ∏è</div>
    <div class="lbl2">–ó–∞–∂–º–∏ ‚Äî —Ä–∏—Å—É–π</div>
  </div>
  <div id="hint">–ù–∞–∫–ª–æ–Ω—è–π —Ç–µ–ª–µ—Ñ–æ–Ω ‚Üí –¥–≤–∏–≥–∞–π –∫–∏—Å—Ç—å<br>–ó–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ‚Üí —Ä–∏—Å—É–π</div>
  <div class="ctrl">
    <label>–†–∞–∑–º–µ—Ä: <span id="sz-val">10</span>px</label>
    <input type="range" id="sz" min="2" max="50" value="10">
  </div>
  <div class="ctrl">
    <label>–¶–≤–µ—Ç:</label>
    <div class="palette" id="palette"></div>
    <input type="color" id="cpick" value="#1a1a1a">
  </div>
  <button class="btn btn-red" id="btn-clear-phone" style="margin-top:4px">üóë –û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç</button>
</div>

<script>
// ‚îÄ‚îÄ –£—Ç–∏–ª–∏—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function show(id) {
  ['s-home','s-host-code','s-phone-code','s-canvas','s-draw'].forEach(s => {
    const el = document.getElementById(s);
    if (el) { el.classList.remove('active'); el.style.display=''; }
  });
  const target = document.getElementById(id);
  if (id === 's-canvas') { target.style.display='flex'; }
  else { target.classList.add('active'); target.style.display='flex'; }
}

function compress(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    (_,p)=>String.fromCharCode('0x'+p)));
}
function decompress(str) {
  return decodeURIComponent(Array.from(atob(str),
    c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
}
function copyText(text, btn, label) {
  navigator.clipboard.writeText(text).catch(()=>{
    const t=document.createElement('textarea'); t.value=text;
    document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
  });
  btn.textContent='‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
  setTimeout(()=>btn.textContent=label, 2000);
}

// ‚îÄ‚îÄ WebRTC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pc, dc;
function waitIce(p) {
  return new Promise(r=>{
    if(p.iceGatheringState==='complete'){r();return;}
    p.onicegatheringstatechange=()=>{if(p.iceGatheringState==='complete')r();};
    setTimeout(r, 4000);
  });
}

// ‚îÄ‚îÄ –•–û–°–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-host').addEventListener('click', async ()=>{
  show('s-host-code');
  document.getElementById('offer-box').textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';

  pc = new RTCPeerConnection({iceServers:[]});
  dc = pc.createDataChannel('paint');
  dc.onopen    = ()=>{ show('s-canvas'); initCanvas(); document.getElementById('dot').className='on'; document.getElementById('bar-status').textContent='‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á—ë–Ω'; };
  dc.onmessage = e=>handleCmd(JSON.parse(e.data));
  dc.onclose   = ()=>{ document.getElementById('dot').className=''; document.getElementById('bar-status').textContent='‚ö†Ô∏è –¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–∏–ª—Å—è'; };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await waitIce(pc);

  const code = compress(JSON.stringify(pc.localDescription));
  document.getElementById('offer-box').textContent = code;

  document.getElementById('btn-copy-offer').addEventListener('click', ()=>{
    copyText(code, document.getElementById('btn-copy-offer'), 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥');
  });

  document.getElementById('btn-apply-answer').addEventListener('click', async ()=>{
    const raw = document.getElementById('answer-input').value.trim();
    if (!raw) return;
    document.getElementById('msg').textContent = '‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
    try {
      await pc.setRemoteDescription(JSON.parse(decompress(raw)));
      document.getElementById('msg').textContent = '‚è≥ –û–∂–∏–¥–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω...';
    } catch(e) {
      document.getElementById('msg').textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥: ' + e.message;
    }
  });
});

// –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
document.getElementById('btn-reconnect').addEventListener('click', ()=>{
  show('s-home');
});

// ‚îÄ‚îÄ –¢–ï–õ–ï–§–û–ù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-phone').addEventListener('click', ()=>show('s-phone-code'));

document.getElementById('btn-process-offer').addEventListener('click', async ()=>{
  const raw = document.getElementById('offer-input').value.trim();
  if (!raw) return;
  document.getElementById('msg2').textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';

  try {
    const offer = JSON.parse(decompress(raw));
    pc = new RTCPeerConnection({iceServers:[]});
    pc.ondatachannel = e=>{
      dc = e.channel;
      dc.onopen  = ()=>{ show('s-draw'); initGyro(); };
      dc.onclose = ()=>{ show('s-phone-code'); document.getElementById('msg2').textContent='‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ'; };
    };

    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await waitIce(pc);

    const ansCode = compress(JSON.stringify(pc.localDescription));
    document.getElementById('answer-box').textContent = ansCode;
    const sec = document.getElementById('answer-section');
    sec.style.display='flex';

    document.getElementById('btn-copy-answer').addEventListener('click', ()=>{
      copyText(ansCode, document.getElementById('btn-copy-answer'), 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥');
    });

    document.getElementById('msg2').textContent = 'üëÜ –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–æ—Ä–µ';
  } catch(e) {
    document.getElementById('msg2').textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
  }
});

// ‚îÄ‚îÄ –•–û–õ–°–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let drawing=false, lx=null, ly=null, color='#1a1a1a', size=10, nx=.5, ny=.5;
let canvasReady = false;

function initCanvas() {
  if (canvasReady) return;
  canvasReady = true;
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const brush = document.getElementById('brush');

  function resize() {
    canvas.width  = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    ctx.fillStyle = 'white';
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  resize();
  window.addEventListener('resize', resize);

  function drawStep() {
    const x=nx*canvas.width, y=ny*canvas.height;
    brush.style.display='block';
    brush.style.left=(nx*100)+'vw';
    brush.style.top=(48+ny*(window.innerHeight-48))+'px';
    brush.style.width=brush.style.height=size*2+'px';
    brush.style.background=drawing?color:'transparent';
    brush.style.borderColor=color;
    if(!drawing||lx===null){lx=x;ly=y;return;}
    ctx.strokeStyle=color; ctx.lineWidth=size; ctx.lineCap=ctx.lineJoin='round';
    ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(x,y); ctx.stroke();
    lx=x; ly=y;
  }

  window._drawStep = drawStep;
  window._clearCanvas = ()=>{ ctx.fillStyle='white'; ctx.fillRect(0,0,canvas.width,canvas.height); lx=ly=null; };
  document.getElementById('btn-clear').addEventListener('click', window._clearCanvas);
}

function handleCmd(cmd) {
  if (cmd.t==='m') {
    nx=Math.max(0,Math.min(1,nx+cmd.x*.013));
    ny=Math.max(0,Math.min(1,ny+cmd.y*.013));
    if(window._drawStep) window._drawStep();
  } else if(cmd.t==='d') {
    drawing=cmd.v; if(!drawing){lx=ly=null;} if(window._drawStep) window._drawStep();
  } else if(cmd.t==='c') { color=cmd.v; }
  else if(cmd.t==='s')   { size=cmd.v; }
  else if(cmd.t==='clr') { if(window._clearCanvas) window._clearCanvas(); }
}

// ‚îÄ‚îÄ –ì–ò–†–û–°–ö–û–ü ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lb=null, lg=null;
function initGyro() {
  const go = ()=>window.addEventListener('deviceorientation', e=>{
    const b=e.beta||0, g=e.gamma||0;
    if(lb!==null){ const dx=g-lg, dy=b-lb; if(Math.abs(dx)>.3||Math.abs(dy)>.3) send({t:'m',x:dx,y:dy}); }
    lb=b; lg=g;
  });
  if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function')
    DeviceMotionEvent.requestPermission().then(r=>{ if(r==='granted') go(); }).catch(go);
  else go();
}

function send(obj) { if(dc&&dc.readyState==='open') dc.send(JSON.stringify(obj)); }

// ‚îÄ‚îÄ –ö–ù–û–ü–ö–ê –ö–ò–°–¢–¨ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const bb = document.getElementById('brush-btn');
bb.addEventListener('touchstart', e=>{ e.preventDefault(); send({t:'d',v:true}); bb.classList.add('on'); bb.querySelector('.lbl2').textContent='üî¥ –†–∏—Å—É—é!'; }, {passive:false});
bb.addEventListener('touchend',   e=>{ e.preventDefault(); send({t:'d',v:false}); bb.classList.remove('on'); bb.querySelector('.lbl2').textContent='–ó–∞–∂–º–∏ ‚Äî —Ä–∏—Å—É–π'; }, {passive:false});
bb.addEventListener('mousedown', ()=>{ send({t:'d',v:true}); bb.classList.add('on'); });
document.addEventListener('mouseup', ()=>{ send({t:'d',v:false}); bb.classList.remove('on'); });

// ‚îÄ‚îÄ –†–ê–ó–ú–ï–† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('sz').addEventListener('input', e=>{
  document.getElementById('sz-val').textContent=e.target.value;
  send({t:'s',v:+e.target.value});
});

// ‚îÄ‚îÄ –ü–ê–õ–ò–¢–†–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeColor='#1a1a1a';
['#1a1a1a','#e63946','#f4a261','#2a9d8f','#e9c46a','#a8dadc','#6a4c93','#4a90e2','#ffffff'].forEach(c=>{
  const b=document.createElement('div');
  b.className='cb'+(c===activeColor?' sel':'');
  b.style.background=c;
  if(c==='#ffffff') b.style.border='3px solid #555';
  b.addEventListener('click',()=>{
    document.querySelectorAll('.cb').forEach(x=>x.classList.remove('sel'));
    b.classList.add('sel'); activeColor=c; send({t:'c',v:c});
  });
  document.getElementById('palette').appendChild(b);
});
document.getElementById('cpick').addEventListener('input', e=>{
  activeColor=e.target.value;
  document.querySelectorAll('.cb').forEach(x=>x.classList.remove('sel'));
  send({t:'c',v:activeColor});
});
document.getElementById('btn-clear-phone').addEventListener('click',()=>send({t:'clr'}));
</script>
</body>
</html>
