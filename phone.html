<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üé® –•–æ–ª—Å—Ç</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#111; color:white; font-family:Arial,sans-serif; overflow:hidden; height:100vh; }

    #ui {
      position:fixed; top:0; left:0; right:0; height:52px;
      background:rgba(0,0,0,0.9); border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex; align-items:center; gap:14px; padding:0 20px; z-index:10;
    }
    #dot { width:10px; height:10px; border-radius:50%; background:#ffd700; flex-shrink:0; }
    #dot.on { background:#00ff88; box-shadow:0 0 8px #00ff88; }
    #ui-status { font-size:14px; color:#aaa; }
    #clear-btn {
      margin-left:auto; background:rgba(255,60,60,0.25);
      border:1px solid rgba(255,60,60,0.4); color:white;
      padding:6px 18px; border-radius:20px; cursor:pointer; font-size:13px;
    }

    #canvas-wrap { position:absolute; top:52px; left:0; right:0; bottom:0; }
    canvas { width:100%; height:100%; display:block; }

    #brush {
      position:fixed; border-radius:50%; pointer-events:none;
      transform:translate(-50%,-50%); border:3px solid #333;
      z-index:5; display:none;
    }

    /* –û–≤–µ—Ä–ª–µ–π */
    #overlay {
      position:fixed; inset:0; background:#09091a;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:100; gap:16px; padding:20px;
    }
    h1 { font-size:28px; }
    .sub { color:#666; font-size:15px; text-align:center; }

    /* –®–∞–≥–∏ */
    .step {
      width:100%; max-width:600px;
      background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1);
      border-radius:16px; padding:18px 22px;
    }
    .step-title { font-size:13px; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }

    /* –ö–æ–¥ –æ—Ñ—Ñ–µ—Ä */
    #offer-box {
      font-size:11px; font-family:'Courier New',monospace;
      background:#000; color:#0f0; padding:12px; border-radius:10px;
      word-break:break-all; line-height:1.5; max-height:80px; overflow:hidden;
      margin-bottom:10px;
    }
    #copy-btn {
      background:#4a90e2; border:none; color:white;
      padding:8px 20px; border-radius:10px; cursor:pointer; font-size:14px;
    }
    #copy-btn:active { background:#2a70c2; }

    /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞ */
    #answer-area {
      width:100%; font-size:11px; font-family:'Courier New',monospace;
      background:#000; color:#0f0; border:1px solid rgba(255,255,255,0.15);
      border-radius:10px; padding:10px; height:80px; resize:none;
      margin-bottom:10px;
    }
    #connect-btn {
      background:#00c853; border:none; color:white;
      padding:8px 24px; border-radius:10px; cursor:pointer; font-size:14px;
    }
    #connect-btn:disabled { background:#333; color:#666; cursor:default; }

    #step2 { opacity:0.4; pointer-events:none; transition:opacity .3s; }
    #step2.active { opacity:1; pointer-events:auto; }

    #conn-status { font-size:13px; color:#888; min-height:18px; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
    .blinking { animation:blink 1.5s infinite; }
  </style>
</head>
<body>

<div id="ui">
  <div id="dot"></div>
  <div id="ui-status">–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞...</div>
  <button id="clear-btn">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<div id="canvas-wrap"><canvas id="c"></canvas></div>
<div id="brush"></div>

<div id="overlay">
  <h1>üé® –•–æ–ª—Å—Ç —Ö—É–¥–æ–∂–Ω–∏–∫–∞</h1>
  <p class="sub">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω-–∫–∏—Å—Ç—å ‚Äî –¥–≤–∞ —à–∞–≥–∞</p>

  <!-- –®–∞–≥ 1: —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ñ—Ñ–µ—Ä -->
  <div class="step" id="step1">
    <div class="step-title">–®–∞–≥ 1 ‚Äî –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</div>
    <div id="offer-box" class="blinking">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞...</div>
    <button id="copy-btn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
  </div>

  <!-- –®–∞–≥ 2: –≤—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç -->
  <div class="step" id="step2">
    <div class="step-title">–®–∞–≥ 2 ‚Äî –í—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å—é–¥–∞</div>
    <textarea id="answer-area" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞..."></textarea>
    <button id="connect-btn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  </div>

  <div id="conn-status"></div>
</div>

<script>
// ‚îÄ‚îÄ Canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('c');
const ctx    = canvas.getContext('2d');
const brush  = document.getElementById('brush');

function resize() {
  canvas.width  = canvas.parentElement.offsetWidth;
  canvas.height = canvas.parentElement.offsetHeight;
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}
resize();
window.addEventListener('resize', resize);

let drawing=false, lx=null, ly=null, color='#1a1a1a', size=10, nx=.5, ny=.5;

function drawStep() {
  const x = nx * canvas.width, y = ny * canvas.height;
  brush.style.display    = 'block';
  brush.style.left       = (nx*100)+'vw';
  brush.style.top        = (52 + ny*(window.innerHeight-52))+'px';
  brush.style.width      = brush.style.height = size*2+'px';
  brush.style.background = drawing ? color : 'transparent';
  brush.style.borderColor= color;
  if (!drawing || lx===null) { lx=x; ly=y; return; }
  ctx.strokeStyle=color; ctx.lineWidth=size;
  ctx.lineCap=ctx.lineJoin='round';
  ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(x,y); ctx.stroke();
  lx=x; ly=y;
}

function clearCanvas() {
  ctx.fillStyle='white'; ctx.fillRect(0,0,canvas.width,canvas.height);
  lx=ly=null;
}
document.getElementById('clear-btn').addEventListener('click', clearCanvas);

// ‚îÄ‚îÄ WebRTC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pc, dc;

async function init() {
  pc = new RTCPeerConnection({ iceServers:[] }); // –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤ ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å!

  dc = pc.createDataChannel('paint');
  dc.onopen    = onConnected;
  dc.onmessage = e => handleCmd(JSON.parse(e.data));
  dc.onclose   = onDisconnected;

  // –ñ–¥—ë–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ñ—Ñ–µ—Ä
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await waitIce(pc);

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∂–∞—Ç—ã–π –æ—Ñ—Ñ–µ—Ä
  const offerStr = compress(JSON.stringify(pc.localDescription));
  document.getElementById('offer-box').textContent = offerStr;
  document.getElementById('offer-box').classList.remove('blinking');

  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —à–∞–≥ 2
  document.getElementById('step2').classList.add('active');

  document.getElementById('copy-btn').addEventListener('click', () => {
    navigator.clipboard.writeText(offerStr).then(() => {
      document.getElementById('copy-btn').textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      setTimeout(()=>document.getElementById('copy-btn').textContent='üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥', 2000);
    }).catch(() => {
      // –§–æ–ª–ª–±—ç–∫ –¥–ª—è Android TV
      const ta = document.createElement('textarea');
      ta.value = offerStr; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      document.getElementById('copy-btn').textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      setTimeout(()=>document.getElementById('copy-btn').textContent='üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥', 2000);
    });
  });

  document.getElementById('connect-btn').addEventListener('click', async () => {
    const answerStr = document.getElementById('answer-area').value.trim();
    if (!answerStr) return;
    document.getElementById('conn-status').textContent = '‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
    try {
      const answer = JSON.parse(decompress(answerStr));
      await pc.setRemoteDescription(answer);
    } catch(e) {
      document.getElementById('conn-status').textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥: ' + e.message;
    }
  });
}

function waitIce(pc) {
  return new Promise(resolve => {
    if (pc.iceGatheringState === 'complete') { resolve(); return; }
    pc.onicegatheringstatechange = () => {
      if (pc.iceGatheringState === 'complete') resolve();
    };
    setTimeout(resolve, 4000); // –º–∞–∫—Å–∏–º—É–º 4 —Å–µ–∫
  });
}

function onConnected() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('dot').className = 'on';
  document.getElementById('ui-status').textContent = '‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á—ë–Ω';
}

function onDisconnected() {
  document.getElementById('overlay').style.display = 'flex';
  document.getElementById('dot').className = '';
  document.getElementById('ui-status').textContent = '–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–∏–ª—Å—è';
  drawing=false; lx=ly=null;
  init(); // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
}

function handleCmd(cmd) {
  if (cmd.t==='m') {
    nx = Math.max(0, Math.min(1, nx + cmd.x * 0.013));
    ny = Math.max(0, Math.min(1, ny + cmd.y * 0.013));
    drawStep();
  } else if (cmd.t==='d') {
    drawing=cmd.v; if(!drawing){lx=ly=null;} drawStep();
  } else if (cmd.t==='c') { color=cmd.v; }
  else if (cmd.t==='s')   { size=cmd.v; }
  else if (cmd.t==='clr') { clearCanvas(); }
}

// ‚îÄ‚îÄ –°–∂–∞—Ç–∏–µ (base64) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function compress(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    (m,p1)=>String.fromCharCode('0x'+p1)));
}
function decompress(str) {
  return decodeURIComponent(Array.from(atob(str),
    c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
}

init();
</script>
</body>
</html>
